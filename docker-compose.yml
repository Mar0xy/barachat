services:
  mongodb:
    image: mongo:7
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: barachat
    networks:
      - barachat-network
    # No ports exposed externally - only accessible within the network

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - barachat-network
    # No ports exposed externally - only accessible within the network

  api:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/mar0xy/barachat:api
    # Uncomment below to build locally instead:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.api
    environment:
      MONGODB_URI: mongodb://mongodb:27017/barachat
      REDIS_URL: redis://redis:6379
      API_PORT: 3000
      WS_PORT: 3001
      HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production-to-a-secure-random-string}
    networks:
      - barachat-network
    depends_on:
      - mongodb
      - redis
    volumes:
      - uploads_data:/app/uploads
    # No ports exposed externally

  websocket:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/mar0xy/barachat:websocket
    # Uncomment below to build locally instead:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.websocket
    environment:
      MONGODB_URI: mongodb://mongodb:27017/barachat
      REDIS_URL: redis://redis:6379
      API_PORT: 3000
      WS_PORT: 3001
      HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production-to-a-secure-random-string}
    networks:
      - barachat-network
    depends_on:
      - mongodb
      - redis
    # No ports exposed externally

  web:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/mar0xy/barachat:web
    # Uncomment below to build locally instead:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.web
    networks:
      - barachat-network
    depends_on:
      - api
      - websocket
    # No ports exposed externally - served through nginx

  # Nginx reverse proxy - only service with exposed ports
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/conf.d/default.conf
      - uploads_data:/app/uploads:ro
    networks:
      - barachat-network
    depends_on:
      - api
      - websocket
      - web

networks:
  barachat-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  uploads_data:
